<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Ruby-on-rails | JanGaJan.com]]></title>
  <link href="http://jangajan.com/blog/categories/ruby-on-rails/atom.xml" rel="self"/>
  <link href="http://jangajan.com/"/>
  <updated>2014-10-04T03:43:26+09:00</updated>
  <id>http://jangajan.com/</id>
  <author>
    <name><![CDATA[talkto_me]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Rails4でacts-as-taggable-on Gemを使う]]></title>
    <link href="http://jangajan.com/blog/2014/10/04/acts-as-taggable-on-in-rails/"/>
    <updated>2014-10-04T03:40:31+09:00</updated>
    <id>http://jangajan.com/blog/2014/10/04/acts-as-taggable-on-in-rails</id>
    <content type="html"><![CDATA[<p>ユーザーに紐づくタスクに、タグ付けをするという機能を実現する方法です。<br/>
<code>acts-as-taggable-on</code>というgemを利用することで簡単(苦戦した&hellip;)にタグ機能は実現できるそうです。<br/>
なんとかできたっぽい&hellip;</p>

<p>環境は、こんな感じです。</p>

<ul>
<li>Rails 4.1.6</li>
<li>ruby 2.1.2p95</li>
<li>acts-as-taggable-on 3.4.2</li>
</ul>


<p>Githubの<a href="https://github.com/mbleigh/acts-as-taggable-on#tag-ownership">README</a>を参考にしました</p>

<!-- more -->


<h1>Model</h1>

<p>そもそもリレーション関係の設定でハマりましたが、これで良さそうです。<br/>
関係としては<code>user 1-n task</code>となり、taskにタグを設定します。<br/>
タグは、userごとに別々に管理します。</p>

<pre><code class="rb app/models/user.rb">class User &lt; ActiveRecord::Base
  acts_as_tagger
  has_many :tasks, dependent: :destroy
  ...
end
</code></pre>

<pre><code class="rb app/models/task.rb">class Task &lt; ActiveRecord::Base
  acts_as_taggable
  belongs_to :user
  ...
end
</code></pre>

<h1>View</h1>

<p>タグのところだけピックアップ。<br/>
（簡単なサンプル作れば良かった）  <br/>
画面表示するController内のメソッドで、選択可能なタグを<code>@user_tags</code>に入れています。<br/>
タグは複数選択可能にするため、checkboxを利用しました。<br/>
checkbox生成でrailsの仕組みを利用しようとしたのですが、以下の2点を実現しようとしてうまいやり方が見つからなかった&hellip;</p>

<ul>
<li>labelでクリック連携</li>
<li>valueの値をタグの名前</li>
</ul>


<p>form_for内に記述します。</p>

<pre><code class="haml app/views/tasks/_form.html.haml">/ @user_tagsはcontrollerで配列で設定 ex) =&gt; ["tag1", "tag2"]
- @user_tags.each do |tag|
  / tagを複数選択可能にするため、checkboxを利用
  %input{id:"tag-#{tag}" ,name:'task[tag_list][]', type:'checkbox',value:"#{tag}"}
  %label{for:"tag-#{tag}"}
    %span.task-tag
      = "#{tag}"
</code></pre>

<p>タグ付けよりもrailsでcheckbox使うところに時間とられた&hellip;宿題ですね。</p>

<h1>Controller</h1>

<p>リクエストのtask[tag_list]という値の中に、タグが含まれます。<br/>
<code>permit</code>で、配列をチェックしたい場合は、<code>tag_list: []</code>と指定してあげる必要がありました。</p>

<pre><code class="rb app/controllers/tasks_controller.rb">class TasksController &lt; ApplicationController
  ...
  def create
    # current_user =&gt; User.find(session[:user_id])
    @task = current_user.tasks.build(task_params)
    @task.user = current_user
    # tagの設定処理 :withには'tag1, tag2'という形式の文字列を設定することでタグを登録できる
    current_user.tag(@task, :with =&gt; @task.tag_list.join(', '), :on =&gt; :tags)
    if @task.save
      # 成功処理
    else
      # 失敗処理
    end
  end
  ...

  private
  def task_params
    params.require(:task).permit(
      # tag_list: []を指定することで、checkboxの複数の値を配列にして、tag_listに設定可能になる
      :id, :name, :deadline, tag_list: []
    )
  end
end
</code></pre>

<p>もしかしたらもっといいやり方があるかもしれません。<br/>
気をつける場所はいくつかあるものの、意外と簡単かも。</p>

<h1>補足</h1>

<h2>ユーザーが設定しているタグの一覧を取得する</h2>

<pre><code class="rb">@user_tags = current_user.owned_tag_list
=&gt; ["tag1", "tag2"]
</code></pre>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ページ単位のjavascriptにcontent_forを使う]]></title>
    <link href="http://jangajan.com/blog/2014/09/27/content-for/"/>
    <updated>2014-09-27T04:14:07+09:00</updated>
    <id>http://jangajan.com/blog/2014/09/27/content-for</id>
    <content type="html"><![CDATA[<p>ページ単位で特定のjavascriptを実行させたい時に、content_forを使えばいいんだね、という結論でした。</p>

<!-- more -->


<h1>javascriptをページごとのファイルに書けない理由</h1>

<p>そもそもbootstrapで作成したコンテンツにこんな記載がありました。
hamlでyatiのテーマを適用しています。</p>

<pre><code class="haml app/views/layouts/application.html.haml">/ ...ページ最下部
      = yield
/
  Javascripts
  \==================================================
/ Placed at the end of the document so the pages load faster
= javascript_include_tag "yeti"
= yield(:page_javascript) if content_for?(:page_javascript)
</code></pre>

<p>各ページのコンテンツは、<code>= yield</code>に埋め込まれます。<br/>
しかし、<code>= javascript_include_tag "yeti"</code>という処理でJavascriptの定義を追加するため、各ページのhamlにjavascriptを書くとjQueryの処理が動きません。<br/>
そこで、<code>= yield(:page_javascript) if content_for?(:page_javascript)</code>を利用します。</p>

<h1>content_forの使い方</h1>

<p>各ページのhamlの下部でcontent_forを利用することにより、application.html.hamlの<code>= yield(:page_javascript) if...</code>のところに出力されます。</p>

<pre><code class="haml app/views/tasks/new.html.haml">- content_for :page_javascript do
  :javascript
    jQuery('#datetimepicker').datetimepicker();
</code></pre>

<p>なので、ページごとのjavascriptは<code>content_for :page_javascript</code>を利用して書くようにしましょう。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Railsでbootswitchのテーマを適用したらActionView::Template::Error]]></title>
    <link href="http://jangajan.com/blog/2014/09/26/include-css-error-in-rails/"/>
    <updated>2014-09-26T16:49:11+09:00</updated>
    <id>http://jangajan.com/blog/2014/09/26/include-css-error-in-rails</id>
    <content type="html"><![CDATA[<p>bootswitch適用時に発生したActionView::Template::Errorの解消方法です。</p>

<!-- more -->


<h1>bootswatch適用</h1>

<p>以下のようにbootswatchを適用しました。</p>

<pre><code class="rb Gemfile">...
gem 'twitter-bootswatch-rails'
gem 'twitter-bootswatch-rails-helpers'
gem 'therubyracer'
</code></pre>

<p>今回はyetiを適用しています。<br/>
テンプレートエンジンはslimを使っています。</p>

<pre><code class="sh">bundle exec rails g bootswatch:install yeti
bundle exec rails g bootswatch:import yeti
bundle exec rails g bootswatch:layout yeti
mv app/views/layouts/yeti.html.slim app/views/layouts/application.html.slim
</code></pre>

<p>最後のmvでテンプレートファイルの入れ替えを行っています。</p>

<h1>ActionView::Template::Errorエラー</h1>

<p>ここで<code>rails s</code>すると、以下のエラーが発生しました。</p>

<pre><code>ActionView::Template::Error (Asset filtered out and will not be served: add `Rails.application.config.assets.precompile += %w( yeti.css )` to `config/initializers/assets.rb` and restart your server):
     9:     / Le HTML5 shim, for IE6-8 support of HTML elements
    10:     /[if lt IE 9]
    11:       = javascript_include_tag "http://html5shim.googlecode.com/svn/trunk/html5.js"
    12:     = stylesheet_link_tag "yeti", :media =&gt; "all"
    13:     = yield(:page_stylesheet) if content_for?(:page_stylesheet)
    14: 
    15: 
  app/views/layouts/application.html.slim:12:in `_app_views_layouts_application_html_slim__3298097478580668215_70163995513140'


  Rendered vendor/bundle/ruby/2.1.0/gems/actionpack-4.1.6/lib/action_dispatch/middleware/templates/rescues/_trace.html.erb (1.0ms)
  Rendered vendor/bundle/ruby/2.1.0/gems/actionpack-4.1.6/lib/action_dispatch/middleware/templates/rescues/_request_and_response.html.erb (1.0ms)
  Rendered vendor/bundle/ruby/2.1.0/gems/actionpack-4.1.6/lib/action_dispatch/middleware/templates/rescues/template_error.html.erb within rescues/layout (15.5ms)
</code></pre>

<p>テンプレートファイルの12行目、ちょうどyetinテーマのcssのところですね。<br/>
どうやら、呼び込みたいassetsファイルがちゃんとprecompileされていないらしい。<br/>
追加したいなら、<code>config/initializers/assets.rb</code>にこんな感じに追加しろぼけってエラーメッセージ優しい。</p>

<h1>エラー解消</h1>

<p>そんなわけでこんな感じで修正。</p>

<pre><code class="rb config/initializers/assets.rb">Rails.application.config.assets.precompile += %w( yeti.css yeti.js )
</code></pre>

<p>yeti.jsも同じエラーが出たのであわせて解消。<br/>
これで<code>rails s</code>したらスタイル代わった。やった。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ForbiddenAttributesErrorが発生]]></title>
    <link href="http://jangajan.com/blog/2014/09/24/forbiddenattributeserror-in-rails/"/>
    <updated>2014-09-24T02:33:27+09:00</updated>
    <id>http://jangajan.com/blog/2014/09/24/forbiddenattributeserror-in-rails</id>
    <content type="html"><![CDATA[<p>Rails4で、ForbiddenAttributesErrorが発生した場合の対応です。</p>

<h1>ActiveModel::ForbiddenAttributesError発生</h1>

<p>次のようなエラーが発生しました。</p>

<pre><code class="sh">ActiveModel::ForbiddenAttributesError (ActiveModel::ForbiddenAttributesError):
  app/controllers/posts_controller.rb:13:in `create'
</code></pre>

<p>13行目が悪さをしているらしい&hellip;</p>

<pre><code class="rb app/controllers/posts_controller.rb">def create
  @feed = Feed.new(params[:post]) # 13行目
  ...
end
</code></pre>

<!-- more -->


<p>これはmass assignmentの問題を解決するために、Rails4から標準で導入された対応により発生しました。<br/>
mass assignmentとはsubmitしたデータから簡単にModelを作ることができるRailsの仕組みです。<br/>
しかし、意図しないパラメータも含んだ状態でModelが作られるという脆弱性のため、このようなエラーが発生するようになりました。<br/>
mass assignmentの問題とその対策についての詳細な説明は<a href="http://www.willnet.in/48">Rails4.0に含まれる strong_parameters について</a>を参考にしてください。</p>

<h1>対応</h1>

<h2>Model作成に必要なsubmitデータを指定する方法</h2>

<p>Model作成に必要なsubmitデータを明示的に指定し、チェックする方法です。
permitメソッドを使うことで、submitデータを絞り込みます。</p>

<pre><code class="rb app/controllers/posts_controller.rb">def create
  @feed = Post.new(post_params)
  ...
end

private

def post_params
  # submitしたデータのうち、Model作成に必要なものを
  # permitの引数に指定する
  params.require(:params).permit(
    :title, :body
  )
end
</code></pre>

<h2>エラーを発生させない方法</h2>

<p>こちらはmass assignmentの問題を解決していないため、お勧めしません。<br/>
pertmitメソッドを通さず、全てのsubmitデータを利用します。</p>

<pre><code class="rb config/application.rb">  class Application &lt; Rails::Application
    # デフォルトはfalseに設定されている
    config.action_controller.permit_all_parameters = true
  end
</code></pre>

<h1>エラー発生場所</h1>

<p><code>ActiveModel::ForbiddenAttributesError</code>は次の処理で発生します。</p>

<ul>
<li>ActiveModel::ForbiddenAttributesProtection#sanitize_for_mass_assignment(attributes)</li>
</ul>


<p>上述のpermitメソッドを実行することで、データはチェック済みの状態になります。<br/>
このチェック済み状態を確認するのが、<code>sanitize_for_mass_assignment</code>の役割です。<br/>
permitメソッドは<code>ActionController::Parameters</code>に定義してあります。</p>

<h1>未チェックのsumitデータがあった場合の対応</h1>

<p>未チェックのsubmitデータがあった場合の挙動をコントロールできます。<br/>
<code>config.action_controller.action_on_unpermitted_parameters</code>を使います。</p>

<h2>エラーにする</h2>

<pre><code class="rb config/application.rb">  class Application &lt; Rails::Application
    config.action_controller.action_on_unpermitted_parameters = :raise
  end
</code></pre>

<h2>ログに出力する</h2>

<pre><code class="rb config/application.rb">  class Application &lt; Rails::Application
    config.action_controller.action_on_unpermitted_parameters = :log
  end
</code></pre>

<p>出力結果はこうなります。
<code>sh
Unpermitted parameters: hogehoge
</code></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[I18nの設定でdatetime_selectの月表示がおかしい]]></title>
    <link href="http://jangajan.com/blog/2014/09/12/perfect-rails-i18n-months/"/>
    <updated>2014-09-12T19:09:36+09:00</updated>
    <id>http://jangajan.com/blog/2014/09/12/perfect-rails-i18n-months</id>
    <content type="html"><![CDATA[<p>前記事に引き続き、i18nの対応です。<br/>
これいっぱいありそう。<br/>
datetime_selectで表示した<code>月</code>欄の表示が妙だ。</p>

<!-- more -->


<h1>ja.ymlにmonth_namesを追加</h1>

<p>翻訳ファイルに<code>month_names</code>を追加しましょう。</p>

<pre><code class="yaml config/locals/ja.yml">ja:
  date:
    order: 
      - :year
      - :month
      - :day
    month_names: [~, 1月, 2月, 3月, 4月, 5月, 6月, 7月, 8月, 9月, 10月, 11月, 12月]
</code></pre>

<p>ちなみに月表示には省略形も存在します。(JanuaryだとJanとか)<br/>
この時は<code>abbr_month_names</code>というものを使います。<br/>
日本語だとそもそも表記が短いのであまり意味はないと思いますが、思わぬところでエラーが発生したらそちらを疑いましょう。</p>

<p>これもactivesupportにenの設定はありました。<br/>
曜日も同様なんでご注意を。
と思ったら、素晴らしいものがありました。</p>

<ul>
<li><a href="https://github.com/svenfuchs/rails-i18n/blob/master/rails/locale/ja.yml">https://github.com/svenfuchs/rails-i18n/blob/master/rails/locale/ja.yml</a>

<ul>
<li>各言語ごとにあるのでこれベースにするのがいいですね。</li>
</ul>
</li>
</ul>

]]></content>
  </entry>
  
</feed>
