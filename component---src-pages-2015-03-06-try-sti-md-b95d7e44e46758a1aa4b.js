(window.webpackJsonp=window.webpackJsonp||[]).push([[53],{"1v56":function(e,t,a){"use strict";a.r(t),a.d(t,"_frontmatter",(function(){return b})),a.d(t,"default",(function(){return s}));a("rGqo"),a("yt8O"),a("Btvt"),a("RW0V"),a("91GP"),a("q1tI");var n=a("7ljp"),r=a("Bl7J");var b={},l={_frontmatter:b},c=r.a;function s(e){var t=e.components,a=function(e,t){if(null==e)return{};var a,n,r={},b=Object.keys(e);for(n=0;n<b.length;n++)a=b[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,["components"]);return Object(n.b)(c,Object.assign({},l,a,{components:t,mdxType:"MDXLayout"}),Object(n.b)("h1",null,"Single Table Inheritance(STI)とは"),Object(n.b)("p",null,"単一テーブル継承というデザインパターンです。テーブルベースの継承階層を表現しています。Ruby同様、継承元は一つのテーブルだけです。",Object(n.b)("br",{parentName:"p"}),"\n",Object(n.b)("a",Object.assign({parentName:"p"},{href:"http://www.martinfowler.com/eaaCatalog/singleTableInheritance.html"}),"こちら"),"に具体的なイメージがあります。",Object(n.b)("br",{parentName:"p"}),"\n","早速RailsでSTIをどうやるのか調べてみます。"),Object(n.b)("h1",null,"環境"),Object(n.b)("table",null,Object(n.b)("thead",{parentName:"table"},Object(n.b)("tr",{parentName:"thead"},Object(n.b)("th",Object.assign({parentName:"tr"},{align:"left"}),"tool"),Object(n.b)("th",Object.assign({parentName:"tr"},{align:"right"}),"version"))),Object(n.b)("tbody",{parentName:"table"},Object(n.b)("tr",{parentName:"tbody"},Object(n.b)("td",Object.assign({parentName:"tr"},{align:"left"}),"ruby"),Object(n.b)("td",Object.assign({parentName:"tr"},{align:"right"}),"2.2.0")),Object(n.b)("tr",{parentName:"tbody"},Object(n.b)("td",Object.assign({parentName:"tr"},{align:"left"}),"rails"),Object(n.b)("td",Object.assign({parentName:"tr"},{align:"right"}),"4.2.0")))),Object(n.b)("h1",null,"試す"),Object(n.b)("p",null,"まずは準備をします。"),Object(n.b)("pre",null,Object(n.b)("code",Object.assign({parentName:"pre"},{className:"language-sh"}),"$ bundle exec rails new sti_type --no-test-framework --skip-bundle\n$ bundle exec rails g model user name:string age:integer type:string\n$ bundle exec rake db:migrate\n")),Object(n.b)("p",null,"RailsでのSTIではmodelの ",Object(n.b)("inlineCode",{parentName:"p"},"type")," というカラムが重要な役割を果たします。"),Object(n.b)("pre",null,Object(n.b)("code",Object.assign({parentName:"pre"},{className:"language-rb",metastring:"app/models/guest.rb","app/models/guest.rb":!0}),"class Guest < User; end\n")),Object(n.b)("pre",null,Object(n.b)("code",Object.assign({parentName:"pre"},{className:"language-rb",metastring:"app/models/host.rb","app/models/host.rb":!0}),"class Host < User; end\n")),Object(n.b)("p",null,"継承ツリーとしてはこんな感じになります。"),Object(n.b)("pre",null,Object(n.b)("code",Object.assign({parentName:"pre"},{}),"ActiveRecord::Base\n        |\n       User\n   _____|_____\n  |           |\nGuest        Host\n")),Object(n.b)("p",null,"これで一通りの準備が整いました。 ",Object(n.b)("inlineCode",{parentName:"p"},"rails console")," で動作を確認してみます。"),Object(n.b)("pre",null,Object(n.b)("code",Object.assign({parentName:"pre"},{className:"language-rb"}),'$ bundle exec rails c\n> Guest.create(name: \'Mark\', age: 18)\n> Host.create(name: \'Yamada\', age: 50)\n\n> pp User.all\n[#<Guest:0x007f84c1279a00\n  id: 1,\n  name: "Mark",\n  age: 18,\n  type: "Guest",\n  created_at: Thu, 05 Mar 2015 19:43:24 UTC +00:00,\n  updated_at: Thu, 05 Mar 2015 19:43:24 UTC +00:00>,\n #<Host:0x007f84c1279870\n  id: 2,\n  name: "Yamada",\n  age: 50,\n  type: "Host",\n  created_at: Thu, 05 Mar 2015 19:44:02 UTC +00:00,\n  updated_at: Thu, 05 Mar 2015 19:44:02 UTC +00:00>]\n\n> pp Guest.all\n[#<Guest:0x007f84c2b54b10\n  id: 1,\n  name: "Mark",\n  age: 18,\n  type: "Guest",\n  created_at: Thu, 05 Mar 2015 19:43:24 UTC +00:00,\n  updated_at: Thu, 05 Mar 2015 19:43:24 UTC +00:00>]\n')),Object(n.b)("p",null,Object(n.b)("inlineCode",{parentName:"p"},"type")," に、自分のクラス名がGuestだったら'Guest'と入ります。 ",Object(n.b)("inlineCode",{parentName:"p"},"Guest")," だけの属性を集めたい場合は ",Object(n.b)("inlineCode",{parentName:"p"},"Guest.all")," とすることで取得できます。"),Object(n.b)("h1",null,Object(n.b)("inlineCode",{parentName:"h1"},"type"),"以外のカラムにクラス情報を格納したい"),Object(n.b)("p",null,"なにがしかの理由で ",Object(n.b)("inlineCode",{parentName:"p"},"type")," は使えない場合、 ",Object(n.b)("inlineCode",{parentName:"p"},"self.inheritance_column")," を使うことで、別のカラムをクラス名を格納するカラムに指定することができます。\n例えば、 ",Object(n.b)("inlineCode",{parentName:"p"},"role")," というカラムを使いたい場合です。"),Object(n.b)("h2",null,"準備"),Object(n.b)("p",null,"汚いですが前のサンプルをそのまま使います。",Object(n.b)("br",{parentName:"p"}),"\n",Object(n.b)("inlineCode",{parentName:"p"},"role"),"というカラムを追加します。"),Object(n.b)("pre",null,Object(n.b)("code",Object.assign({parentName:"pre"},{}),"$ bundle exec rails g migration AddRoleToUser\n")),Object(n.b)("pre",null,Object(n.b)("code",Object.assign({parentName:"pre"},{className:"language-rb",metastring:"db/migrate/20150305201347_add_role_to_user.rb","db/migrate/20150305201347_add_role_to_user.rb":!0}),"class AddRoleToUser < ActiveRecord::Migration\n  def change\n    add_column :users, :role, :string\n  end\nend\n")),Object(n.b)("p",null,"データを綺麗にしたいのでDB作り直します。"),Object(n.b)("pre",null,Object(n.b)("code",Object.assign({parentName:"pre"},{className:"language-sh"}),"$ bundle exec rake db:setup\n$ bundle exec rake db:migrate\n")),Object(n.b)("p",null,"大事なのはここだけです。 ",Object(n.b)("inlineCode",{parentName:"p"},"self.inheritance_column")," に ",Object(n.b)("inlineCode",{parentName:"p"},"role")," を指定します。"),Object(n.b)("pre",null,Object(n.b)("code",Object.assign({parentName:"pre"},{className:"language-rb",metastring:"app/models/user.rb","app/models/user.rb":!0}),"class User < ActiveRecord::Base\n  self.inheritance_column = :role\nend\n")),Object(n.b)("h2",null,"確認"),Object(n.b)("pre",null,Object(n.b)("code",Object.assign({parentName:"pre"},{className:"language-rb"}),'> Guest.create(name: \'Bob\', age: 1000)\n> Host.create(name: \'Tanaka\', age: 100)\n> pp User.all\n[#<Guest:0x007fe248c19c60\n  id: 3,\n  name: "Bob",\n  age: 1000,\n  type: nil,\n  created_at: Thu, 05 Mar 2015 20:23:55 UTC +00:00,\n  updated_at: Thu, 05 Mar 2015 20:23:55 UTC +00:00,\n  role: "Guest">,\n #<Host:0x007fe248c19ad0\n  id: 4,\n  name: "Tanaka",\n  age: 100,\n  type: nil,\n  created_at: Thu, 05 Mar 2015 20:24:10 UTC +00:00,\n  updated_at: Thu, 05 Mar 2015 20:24:10 UTC +00:00,\n  role: "Host">]\n')),Object(n.b)("p",null,Object(n.b)("inlineCode",{parentName:"p"},"type")," ではなく、 ",Object(n.b)("inlineCode",{parentName:"p"},"role")," を使用していることが確認できました。"),Object(n.b)("h1",null,"注意点"),Object(n.b)("p",null,"注意しなければいけなそうな点は、こんな感じでしょうか。"),Object(n.b)("ul",null,Object(n.b)("li",{parentName:"ul"},"子クラス(",Object(n.b)("inlineCode",{parentName:"li"},"Guest")," や ",Object(n.b)("inlineCode",{parentName:"li"},"Host"),")ごとに特別のカラムが欲しい場合、 ",Object(n.b)("inlineCode",{parentName:"li"},"users")," に追加する必要があり、",Object(n.b)("inlineCode",{parentName:"li"},"nil"),"を許容しなければいけない",Object(n.b)("ul",{parentName:"li"},Object(n.b)("li",{parentName:"ul"},Object(n.b)("inlineCode",{parentName:"li"},"Guest")," で使うが ",Object(n.b)("inlineCode",{parentName:"li"},"Host")," では使用しないケースがあるから"))),Object(n.b)("li",{parentName:"ul"},"子クラスごとに、カラムの型を変えることはできない")))}s.isMDXComponent=!0},Bl7J:function(e,t,a){"use strict";var n=a("dwav"),r=a("q1tI"),b=a.n(r),l=a("Wbzz"),c=function(e){var t=e.siteTitle;return b.a.createElement("header",{style:{background:"white",marginBottom:"1.45rem"}},b.a.createElement("div",{style:{margin:"0 auto",maxWidth:960,padding:"1.45rem 1.0875rem"}},b.a.createElement("h1",{style:{margin:0}},b.a.createElement(l.Link,{to:"/",style:{color:"black",textDecoration:"none"}},t))))};c.defaultProps={siteTitle:""};var s=c;a("8ypT"),t.a=function(e){var t=e.children,a=n.data;return b.a.createElement(b.a.Fragment,null,b.a.createElement(s,{siteTitle:a.site.siteMetadata.title}),b.a.createElement("div",{style:{margin:"0 auto",maxWidth:960,padding:"0 1.0875rem 1.45rem"}},b.a.createElement("main",null,t),b.a.createElement("footer",null,"© ",(new Date).getFullYear(),", Built with"," ",b.a.createElement("a",{href:"https://www.gatsbyjs.org"},"Gatsby"),"by ",a.site.siteMetadata.author)))}},dwav:function(e){e.exports=JSON.parse('{"data":{"site":{"siteMetadata":{"title":"jangajan.com","author":"@ta1kt0me"}}}}')}}]);
//# sourceMappingURL=component---src-pages-2015-03-06-try-sti-md-b95d7e44e46758a1aa4b.js.map